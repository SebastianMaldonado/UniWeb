{% extends 'base_app.html' %}
{% block title %}UniWeb • Perfil{% endblock %}
{% block head_extra %}
  <style>
    :root { --red:#d32f2f; --black:#111; --white:#fff; --border:#e6e6e6; --soft:#f7f7f7; }
    .profile-page { display: grid; gap: 16px; }
    /* Section 1: Cover */
    .cover { position: relative; width: 100%; height: 200px; border-radius: 16px; overflow: hidden; background: #f0f0f0; border: 1px solid var(--border); }
    .cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
    /* Overlapping avatar */
    .avatar-wrap { position: relative; height: 0; }
    .avatar { position: absolute; left: 50%; transform: translate(-50%, -50%); top: -40px; width: 120px; height: 120px; border-radius: 999px; border: 4px solid var(--white); overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.12); background: #fafafa; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    /* Section 2: Name + Bio */
  .info-card { margin-top: 20px; text-align: center; padding: 8px 0; }
    .username { font-size: 20px; font-weight: 700; margin: 0 0 8px; }
    .bio { margin: 0; color: #444; white-space: pre-wrap; }
    /* Section 3: Strip with buttons */
  .strip { display: grid; grid-template-columns: 1fr 1fr; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--white); }
  .strip button { appearance: none; border: none; background: var(--white); padding: 12px; font-weight: 600; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; }
  .strip button:hover { background: #fcfcfc; }
  .strip button + button { border-left: 1px solid var(--border); }
  /* Section 4: Posts feed */
  .posts { min-height: 160px; }
    /* Modal for lists */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal.open { display: flex; }
    .modal-card { background: var(--white); width: min(92vw, 520px); max-height: 80vh; border-radius: 14px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.2); display: grid; grid-template-rows: auto 1fr; }
    .modal-header { padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 700; display: flex; align-items: center; justify-content: space-between; }
    .modal-body { padding: 8px 0; overflow: auto; }
    .user-row { display: grid; grid-template-columns: 44px 1fr; gap: 10px; align-items: center; padding: 10px 14px; }
    .user-row + .user-row { border-top: 1px solid #f2f2f2; }
    .user-row .uimg { width: 44px; height: 44px; border-radius: 999px; overflow: hidden; background: #f4f4f4; border: 1px solid var(--border); }
    .user-row .uimg img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .close-btn { background: transparent; border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .user-row a { color: var(--black); text-decoration: none; }
    .user-row a:hover { text-decoration: underline; }
    /* Follow section on user-profile */
    .follow-section { display:flex; flex-direction: column; align-items:stretch; gap:6px; margin-top: 6px; width:100%; }
    .mutual-note { color:#757575; font-size: 13px; }
    .follow-primary, .follow-secondary { width:100%; text-align:center; }
    .follow-primary { appearance:none; border:1px solid #1976d2; background:#1976d2; color:#fff; padding:12px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    .follow-secondary { appearance:none; border:1px solid #ddd; background:#fff; color:#111; padding:12px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
  </style>
{% endblock %}

{% block content %}
  <div class="profile-page">
    <!-- 1. Cover -->
    <section class="cover" aria-label="Imagen de presentación">
      {% if cover_image_url %}
        <img src="{{ cover_image_url }}" alt="Imagen de presentación" />
      {% else %}
        <img alt="Sin imagen de presentación" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='200'><rect fill='%23eeeeee' width='100%' height='100%'/></svg>" />
      {% endif %}
    </section>

    <!-- Overlapping avatar -->
    <div class="avatar-wrap">
      <div class="avatar" aria-label="Imagen de perfil">
        {% if profile_image_url %}
          <img src="{{ profile_image_url }}" alt="Imagen de perfil" />
        {% else %}
          <img alt="Sin imagen de perfil" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect fill='%23eeeeee' width='100%' height='100%'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23888' font-size='14'>Perfil</text></svg>" />
        {% endif %}
      </div>
    </div>

    <!-- 2. Name + Bio -->
    <section class="info-card">
      <h1 class="username">{{ username }}</h1>
      {% if bio %}
        <p class="bio">{{ bio }}</p>
      {% else %}
        <p class="bio" style="color:#999;">Sin descripción</p>
      {% endif %}
    </section>

    <!-- Follow button for other users -->
    {% if not is_self %}
    <section class="follow-section">
      {% if mutual_count and mutual_count > 0 %}
        <div class="mutual-note">Tienen {{ mutual_count }} amigos en común</div>
      {% endif %}
      <button id="profileFollowBtn" class="{% if is_following %}follow-secondary{% else %}follow-primary{% endif %}" data-username="{{ username }}" data-following="{{ is_following|yesno:'true,false' }}">{% if is_following %}Dejar de seguir{% else %}Seguir{% endif %}</button>
    </section>
    {% endif %}

    <!-- 3. Followers/Following strip -->
    <section class="strip" aria-label="Seguidores y seguidos">
      <button type="button" id="btnFollowers">{{ followers_count }} seguidores</button>
      <button type="button" id="btnFollowing">{{ following_count }} seguidos</button>
    </section>

    <!-- 4. Posts Feed -->
    <section class="posts">
      {% if posts and posts|length > 0 %}
        {% for post in posts %}
          {% include 'post_card.html' with post=post %}
        {% endfor %}
      {% else %}
        <div style="padding:16px; color:#777; background:#fff; border:1px solid #eee; border-radius:12px; text-align:center;">Aún no hay publicaciones</div>
      {% endif %}
    </section>
  </div>

  <!-- Modal for lists -->
  <div id="listModal" class="modal" role="dialog" aria-modal="true" aria-label="Listado">
    <div class="modal-card">
      <div class="modal-header">
        <span id="modalTitle">Listado</span>
        <button type="button" class="close-btn" id="modalClose">Cerrar</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Users will be injected here -->
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    (function(){
  const followers = JSON.parse('{{ followers_json|escapejs }}');
  const following = JSON.parse('{{ following_json|escapejs }}');
  const profileUsername = '{{ username }}';
  let followersCount = {{ followers_count }};
  let isFollowing = {{ is_following|yesno:'true,false' }} === 'true';
      const modal = document.getElementById('listModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      const modalClose = document.getElementById('modalClose');
      const btnFollowers = document.getElementById('btnFollowers');
      const btnFollowing = document.getElementById('btnFollowing');

      function row(user) {
        const img = user.profile_image_url ? user.profile_image_url : "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44'><rect fill='%23eeeeee' width='100%' height='100%'/></svg>";
        const href = `/user-profile/${user.username}`;
        return `<div class="user-row"><div class="uimg"><img src="${img}" alt="${user.username}"/></div><div><a href="${href}">@${user.username}</a></div></div>`;
      }

      function openList(kind) {
        const items = kind === 'followers' ? followers : following;
        modalTitle.textContent = kind === 'followers' ? 'Seguidores' : 'Seguidos';
        modalBody.innerHTML = items.length ? items.map(row).join('') : '<div style="padding:14px; color:#777;">No hay usuarios</div>';
        modal.classList.add('open');
      }

      btnFollowers.addEventListener('click', () => openList('followers'));
      btnFollowing.addEventListener('click', () => openList('following'));
      modalClose.addEventListener('click', () => modal.classList.remove('open'));
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('open'); });

      // Follow toggle on user-profile
      const followBtn = document.getElementById('profileFollowBtn');
      if (followBtn){
        followBtn.addEventListener('click', async function(){
          const uname = this.getAttribute('data-username');
          try{
            const res = await fetch(`/user/${encodeURIComponent(uname)}/follow-toggle`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if(res.ok){
              const data = await res.json();
              const following = !!data.following;
              this.setAttribute('data-following', following ? 'true' : 'false');
              this.textContent = following ? 'Dejar de seguir' : 'Seguir';
              this.className = following ? 'follow-secondary' : 'follow-primary';
              // Update local state and followers count immediately
              if (following && !isFollowing) { followersCount += 1; isFollowing = true; }
              else if (!following && isFollowing) { followersCount -= 1; isFollowing = false; }
              const btnFollowersEl = document.getElementById('btnFollowers');
              if (btnFollowersEl) btnFollowersEl.textContent = `${followersCount} seguidores`;
              // Update all follow buttons on page for this username
              document.querySelectorAll(`.follow-btn[data-username="${CSS.escape(uname)}"]`).forEach(function(b){
                b.setAttribute('data-following', following ? 'true':'false');
                b.textContent = following ? 'Dejar de seguir' : 'Seguir';
              });
              // Broadcast event so other components can react
              document.dispatchEvent(new CustomEvent('follow-changed', { detail: { username: uname, following } }));
            }
          } catch(e){}
        });
      }

      // Listen to follow changes from post cards within this page
      document.addEventListener('follow-changed', function(e){
        const det = e.detail || {}; const uname = det.username; const following = !!det.following;
        if (!uname) return;
        if (uname === profileUsername) {
          // Update main profile button
          if (followBtn){
            followBtn.setAttribute('data-following', following ? 'true' : 'false');
            followBtn.textContent = following ? 'Dejar de seguir' : 'Seguir';
            followBtn.className = following ? 'follow-secondary' : 'follow-primary';
          }
          // Update followers count
          if (following && !isFollowing) { followersCount += 1; isFollowing = true; }
          else if (!following && isFollowing) { followersCount -= 1; isFollowing = false; }
          const btnFollowersEl = document.getElementById('btnFollowers');
          if (btnFollowersEl) btnFollowersEl.textContent = `${followersCount} seguidores`;
        }
        // Update all follow buttons matching this username
        document.querySelectorAll(`.follow-btn[data-username="${CSS.escape(uname)}"]`).forEach(function(b){
          b.setAttribute('data-following', following ? 'true':'false');
          b.textContent = following ? 'Dejar de seguir' : 'Seguir';
        });
      });
    })();
  </script>
{% endblock %}
